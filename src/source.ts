const rngLen = 607n;
const rngTap = 273n;
const rngMax = 1n << 63n;
const rngMask = rngMax - 1n;
const int32max = (1n << 31n) - 1n;
const int32mask = 0x00000000ffffffffn;

// rngCooked used for seeding. See gen_cooked.go for details.
const rngCooked = [
  -4181792142133755926n,
  -4576982950128230565n,
  1395769623340756751n,
  5333664234075297259n,
  -6347679516498800754n,
  9033628115061424579n,
  7143218595135194537n,
  4812947590706362721n,
  7937252194349799378n,
  5307299880338848416n,
  8209348851763925077n,
  -7107630437535961764n,
  4593015457530856296n,
  8140875735541888011n,
  -5903942795589686782n,
  -603556388664454774n,
  -7496297993371156308n,
  113108499721038619n,
  4569519971459345583n,
  -4160538177779461077n,
  -6835753265595711384n,
  -6507240692498089696n,
  6559392774825876886n,
  7650093201692370310n,
  7684323884043752161n,
  -8965504200858744418n,
  -2629915517445760644n,
  271327514973697897n,
  -6433985589514657524n,
  1065192797246149621n,
  3344507881999356393n,
  -4763574095074709175n,
  7465081662728599889n,
  1014950805555097187n,
  -4773931307508785033n,
  -5742262670416273165n,
  2418672789110888383n,
  5796562887576294778n,
  4484266064449540171n,
  3738982361971787048n,
  -4699774852342421385n,
  10530508058128498n,
  -589538253572429690n,
  -6598062107225984180n,
  8660405965245884302n,
  10162832508971942n,
  -2682657355892958417n,
  7031802312784620857n,
  6240911277345944669n,
  831864355460801054n,
  -1218937899312622917n,
  2116287251661052151n,
  2202309800992166967n,
  9161020366945053561n,
  4069299552407763864n,
  4936383537992622449n,
  457351505131524928n,
  -8881176990926596454n,
  -6375600354038175299n,
  -7155351920868399290n,
  4368649989588021065n,
  887231587095185257n,
  -3659780529968199312n,
  -2407146836602825512n,
  5616972787034086048n,
  -751562733459939242n,
  1686575021641186857n,
  -5177887698780513806n,
  -4979215821652996885n,
  -1375154703071198421n,
  5632136521049761902n,
  -8390088894796940536n,
  -193645528485698615n,
  -5979788902190688516n,
  -4907000935050298721n,
  -285522056888777828n,
  -2776431630044341707n,
  1679342092332374735n,
  6050638460742422078n,
  -2229851317345194226n,
  -1582494184340482199n,
  5881353426285907985n,
  812786550756860885n,
  4541845584483343330n,
  -6497901820577766722n,
  4980675660146853729n,
  -4012602956251539747n,
  -329088717864244987n,
  -2896929232104691526n,
  1495812843684243920n,
  -2153620458055647789n,
  7370257291860230865n,
  -2466442761497833547n,
  4706794511633873654n,
  -1398851569026877145n,
  8549875090542453214n,
  -9189721207376179652n,
  -7894453601103453165n,
  7297902601803624459n,
  1011190183918857495n,
  -6985347000036920864n,
  5147159997473910359n,
  -8326859945294252826n,
  2659470849286379941n,
  6097729358393448602n,
  -7491646050550022124n,
  -5117116194870963097n,
  -896216826133240300n,
  -745860416168701406n,
  5803876044675762232n,
  -787954255994554146n,
  -3234519180203704564n,
  -4507534739750823898n,
  -1657200065590290694n,
  505808562678895611n,
  -4153273856159712438n,
  -8381261370078904295n,
  572156825025677802n,
  1791881013492340891n,
  3393267094866038768n,
  -5444650186382539299n,
  2352769483186201278n,
  -7930912453007408350n,
  -325464993179687389n,
  -3441562999710612272n,
  -6489413242825283295n,
  5092019688680754699n,
  -227247482082248967n,
  4234737173186232084n,
  5027558287275472836n,
  4635198586344772304n,
  -536033143587636457n,
  5907508150730407386n,
  -8438615781380831356n,
  972392927514829904n,
  -3801314342046600696n,
  -4064951393885491917n,
  -174840358296132583n,
  2407211146698877100n,
  -1640089820333676239n,
  3940796514530962282n,
  -5882197405809569433n,
  3095313889586102949n,
  -1818050141166537098n,
  5832080132947175283n,
  7890064875145919662n,
  8184139210799583195n,
  -8073512175445549678n,
  -7758774793014564506n,
  -4581724029666783935n,
  3516491885471466898n,
  -8267083515063118116n,
  6657089965014657519n,
  5220884358887979358n,
  1796677326474620641n,
  5340761970648932916n,
  1147977171614181568n,
  5066037465548252321n,
  2574765911837859848n,
  1085848279845204775n,
  -5873264506986385449n,
  6116438694366558490n,
  2107701075971293812n,
  -7420077970933506541n,
  2469478054175558874n,
  -1855128755834809824n,
  -5431463669011098282n,
  -9038325065738319171n,
  -6966276280341336160n,
  7217693971077460129n,
  -8314322083775271549n,
  7196649268545224266n,
  -3585711691453906209n,
  -5267827091426810625n,
  8057528650917418961n,
  -5084103596553648165n,
  -2601445448341207749n,
  -7850010900052094367n,
  6527366231383600011n,
  3507654575162700890n,
  9202058512774729859n,
  1954818376891585542n,
  -2582991129724600103n,
  8299563319178235687n,
  -5321504681635821435n,
  7046310742295574065n,
  -2376176645520785576n,
  -7650733936335907755n,
  8850422670118399721n,
  3631909142291992901n,
  5158881091950831288n,
  -6340413719511654215n,
  4763258931815816403n,
  6280052734341785344n,
  -4979582628649810958n,
  2043464728020827976n,
  -2678071570832690343n,
  4562580375758598164n,
  5495451168795427352n,
  -7485059175264624713n,
  553004618757816492n,
  6895160632757959823n,
  -989748114590090637n,
  7139506338801360852n,
  -672480814466784139n,
  5535668688139305547n,
  2430933853350256242n,
  -3821430778991574732n,
  -1063731997747047009n,
  -3065878205254005442n,
  7632066283658143750n,
  6308328381617103346n,
  3681878764086140361n,
  3289686137190109749n,
  6587997200611086848n,
  244714774258135476n,
  -5143583659437639708n,
  8090302575944624335n,
  2945117363431356361n,
  -8359047641006034763n,
  3009039260312620700n,
  -793344576772241777n,
  401084700045993341n,
  -1968749590416080887n,
  4707864159563588614n,
  -3583123505891281857n,
  -3240864324164777915n,
  -5908273794572565703n,
  -3719524458082857382n,
  -5281400669679581926n,
  8118566580304798074n,
  3839261274019871296n,
  7062410411742090847n,
  -8481991033874568140n,
  6027994129690250817n,
  -6725542042704711878n,
  -2971981702428546974n,
  -7854441788951256975n,
  8809096399316380241n,
  6492004350391900708n,
  2462145737463489636n,
  -8818543617934476634n,
  -5070345602623085213n,
  -8961586321599299868n,
  -3758656652254704451n,
  -8630661632476012791n,
  6764129236657751224n,
  -709716318315418359n,
  -3403028373052861600n,
  -8838073512170985897n,
  -3999237033416576341n,
  -2920240395515973663n,
  -2073249475545404416n,
  368107899140673753n,
  -6108185202296464250n,
  -6307735683270494757n,
  4782583894627718279n,
  6718292300699989587n,
  8387085186914375220n,
  3387513132024756289n,
  4654329375432538231n,
  -292704475491394206n,
  -3848998599978456535n,
  7623042350483453954n,
  7725442901813263321n,
  9186225467561587250n,
  -5132344747257272453n,
  -6865740430362196008n,
  2530936820058611833n,
  1636551876240043639n,
  -3658707362519810009n,
  1452244145334316253n,
  -7161729655835084979n,
  -7943791770359481772n,
  9108481583171221009n,
  -3200093350120725999n,
  5007630032676973346n,
  2153168792952589781n,
  6720334534964750538n,
  -3181825545719981703n,
  3433922409283786309n,
  2285479922797300912n,
  3110614940896576130n,
  -2856812446131932915n,
  -3804580617188639299n,
  7163298419643543757n,
  4891138053923696990n,
  580618510277907015n,
  1684034065251686769n,
  4429514767357295841n,
  -8893025458299325803n,
  -8103734041042601133n,
  7177515271653460134n,
  4589042248470800257n,
  -1530083407795771245n,
  143607045258444228n,
  246994305896273627n,
  -8356954712051676521n,
  6473547110565816071n,
  3092379936208876896n,
  2058427839513754051n,
  -4089587328327907870n,
  8785882556301281247n,
  -3074039370013608197n,
  -637529855400303673n,
  6137678347805511274n,
  -7152924852417805802n,
  5708223427705576541n,
  -3223714144396531304n,
  4358391411789012426n,
  325123008708389849n,
  6837621693887290924n,
  4843721905315627004n,
  -3212720814705499393n,
  -3825019837890901156n,
  4602025990114250980n,
  1044646352569048800n,
  9106614159853161675n,
  -8394115921626182539n,
  -4304087667751778808n,
  2681532557646850893n,
  3681559472488511871n,
  -3915372517896561773n,
  -2889241648411946534n,
  -6564663803938238204n,
  -8060058171802589521n,
  581945337509520675n,
  3648778920718647903n,
  -4799698790548231394n,
  -7602572252857820065n,
  220828013409515943n,
  -1072987336855386047n,
  4287360518296753003n,
  -4633371852008891965n,
  5513660857261085186n,
  -2258542936462001533n,
  -8744380348503999773n,
  8746140185685648781n,
  228500091334420247n,
  1356187007457302238n,
  3019253992034194581n,
  3152601605678500003n,
  -8793219284148773595n,
  5559581553696971176n,
  4916432985369275664n,
  -8559797105120221417n,
  -5802598197927043732n,
  2868348622579915573n,
  -7224052902810357288n,
  -5894682518218493085n,
  2587672709781371173n,
  -7706116723325376475n,
  3092343956317362483n,
  -5561119517847711700n,
  972445599196498113n,
  -1558506600978816441n,
  1708913533482282562n,
  -2305554874185907314n,
  -6005743014309462908n,
  -6653329009633068701n,
  -483583197311151195n,
  2488075924621352812n,
  -4529369641467339140n,
  -4663743555056261452n,
  2997203966153298104n,
  1282559373026354493n,
  240113143146674385n,
  8665713329246516443n,
  628141331766346752n,
  -4651421219668005332n,
  -7750560848702540400n,
  7596648026010355826n,
  -3132152619100351065n,
  7834161864828164065n,
  7103445518877254909n,
  4390861237357459201n,
  -4780718172614204074n,
  -319889632007444440n,
  622261699494173647n,
  -3186110786557562560n,
  -8718967088789066690n,
  -1948156510637662747n,
  -8212195255998774408n,
  -7028621931231314745n,
  2623071828615234808n,
  -4066058308780939700n,
  -5484966924888173764n,
  -6683604512778046238n,
  -6756087640505506466n,
  5256026990536851868n,
  7841086888628396109n,
  6640857538655893162n,
  -8021284697816458310n,
  -7109857044414059830n,
  -1689021141511844405n,
  -4298087301956291063n,
  -4077748265377282003n,
  -998231156719803476n,
  2719520354384050532n,
  9132346697815513771n,
  4332154495710163773n,
  -2085582442760428892n,
  6994721091344268833n,
  -2556143461985726874n,
  -8567931991128098309n,
  59934747298466858n,
  -3098398008776739403n,
  -265597256199410390n,
  2332206071942466437n,
  -7522315324568406181n,
  3154897383618636503n,
  -7585605855467168281n,
  -6762850759087199275n,
  197309393502684135n,
  -8579694182469508493n,
  2543179307861934850n,
  4350769010207485119n,
  -4468719947444108136n,
  -7207776534213261296n,
  -1224312577878317200n,
  4287946071480840813n,
  8362686366770308971n,
  6486469209321732151n,
  -5605644191012979782n,
  -1669018511020473564n,
  4450022655153542367n,
  -7618176296641240059n,
  -3896357471549267421n,
  -4596796223304447488n,
  -6531150016257070659n,
  -8982326463137525940n,
  -4125325062227681798n,
  -1306489741394045544n,
  -8338554946557245229n,
  5329160409530630596n,
  7790979528857726136n,
  4955070238059373407n,
  -4304834761432101506n,
  -6215295852904371179n,
  3007769226071157901n,
  -6753025801236972788n,
  8928702772696731736n,
  7856187920214445904n,
  -4748497451462800923n,
  7900176660600710914n,
  -7082800908938549136n,
  -6797926979589575837n,
  -6737316883512927978n,
  4186670094382025798n,
  1883939007446035042n,
  -414705992779907823n,
  3734134241178479257n,
  4065968871360089196n,
  6953124200385847784n,
  -7917685222115876751n,
  -7585632937840318161n,
  -5567246375906782599n,
  -5256612402221608788n,
  3106378204088556331n,
  -2894472214076325998n,
  4565385105440252958n,
  1979884289539493806n,
  -6891578849933910383n,
  3783206694208922581n,
  8464961209802336085n,
  2843963751609577687n,
  3030678195484896323n,
  -4429654462759003204n,
  4459239494808162889n,
  402587895800087237n,
  8057891408711167515n,
  4541888170938985079n,
  1042662272908816815n,
  -3666068979732206850n,
  2647678726283249984n,
  2144477441549833761n,
  -3417019821499388721n,
  -2105601033380872185n,
  5916597177708541638n,
  -8760774321402454447n,
  8833658097025758785n,
  5970273481425315300n,
  563813119381731307n,
  -6455022486202078793n,
  1598828206250873866n,
  -4016978389451217698n,
  -2988328551145513985n,
  -6071154634840136312n,
  8469693267274066490n,
  125672920241807416n,
  -3912292412830714870n,
  -2559617104544284221n,
  -486523741806024092n,
  -4735332261862713930n,
  5923302823487327109n,
  -9082480245771672572n,
  -1808429243461201518n,
  7990420780896957397n,
  4317817392807076702n,
  3625184369705367340n,
  -6482649271566653105n,
  -3480272027152017464n,
  -3225473396345736649n,
  -368878695502291645n,
  -3981164001421868007n,
  -8522033136963788610n,
  7609280429197514109n,
  3020985755112334161n,
  -2572049329799262942n,
  2635195723621160615n,
  5144520864246028816n,
  -8188285521126945980n,
  1567242097116389047n,
  8172389260191636581n,
  -2885551685425483535n,
  -7060359469858316883n,
  -6480181133964513127n,
  -7317004403633452381n,
  6011544915663598137n,
  5932255307352610768n,
  2241128460406315459n,
  -8327867140638080220n,
  3094483003111372717n,
  4583857460292963101n,
  9079887171656594975n,
  -384082854924064405n,
  -3460631649611717935n,
  4225072055348026230n,
  -7385151438465742745n,
  3801620336801580414n,
  -399845416774701952n,
  -7446754431269675473n,
  7899055018877642622n,
  5421679761463003041n,
  5521102963086275121n,
  -4975092593295409910n,
  8735487530905098534n,
  -7462844945281082830n,
  -2080886987197029914n,
  -1000715163927557685n,
  -4253840471931071485n,
  -5828896094657903328n,
  6424174453260338141n,
  359248545074932887n,
  -5949720754023045210n,
  -2426265837057637212n,
  3030918217665093212n,
  -9077771202237461772n,
  -3186796180789149575n,
  740416251634527158n,
  -2142944401404840226n,
  6951781370868335478n,
  399922722363687927n,
  -8928469722407522623n,
  -1378421100515597285n,
  -8343051178220066766n,
  -3030716356046100229n,
  -8811767350470065420n,
  9026808440365124461n,
  6440783557497587732n,
  4615674634722404292n,
  539897290441580544n,
  2096238225866883852n,
  8751955639408182687n,
  -7316147128802486205n,
  7381039757301768559n,
  6157238513393239656n,
  -1473377804940618233n,
  8629571604380892756n,
  5280433031239081479n,
  7101611890139813254n,
  2479018537985767835n,
  7169176924412769570n,
  -1281305539061572506n,
  -7865612307799218120n,
  2278447439451174845n,
  3625338785743880657n,
  6477479539006708521n,
  8976185375579272206n,
  -3712000482142939688n,
  1326024180520890843n,
  7537449876596048829n,
  5464680203499696154n,
  3189671183162196045n,
  6346751753565857109n,
  -8982212049534145501n,
  -6127578587196093755n,
  -245039190118465649n,
  -6320577374581628592n,
  7208698530190629697n,
  7276901792339343736n,
  -7490986807540332668n,
  4133292154170828382n,
  2918308698224194548n,
  -7703910638917631350n,
  -3929437324238184044n,
  -4300543082831323144n,
  -6344160503358350167n,
  5896236396443472108n,
  -758328221503023383n,
  -1894351639983151068n,
  -307900319840287220n,
  -6278469401177312761n,
  -2171292963361310674n,
  8382142935188824023n,
  9103922860780351547n,
  4152330101494654406n,
];

export default class Source {
  // seed rng x[n+1] = 48271 * x[n] mod (2**31 - 1)
  private static seedrand(x: bigint): bigint {
    const A = 48271n;
    const Q = 44488n;
    const R = 3399n;

    const hi: bigint = x / Q;
    const lo: bigint = x % Q;
    x = A * lo - R * hi;
    if (x < 0n) {
      x = x + int32max;
    }
    return x;
  }

  // index into vec
  private tap: bigint;
  // index into vec
  private feed: bigint;
  // current feedback register
  private vec: bigint[];

  // Seed uses the provided seed value to initialize the generator to a deterministic state.
  constructor(seed: bigint) {
    this.tap = BigInt(0);
    this.feed = rngLen - rngTap;
    this.vec = new Array(rngLen);

    seed = seed % int32max;
    if (seed < 0n) {
      seed = seed + int32max;
    }
    if (seed === 0n) {
      seed = 89482311n;
    }

    // Truncate to 32-bit integer.
    let x = seed & int32mask;
    for (let i = -20n; i < rngLen; i++) {
      x = Source.seedrand(x);
      if (i >= 0n) {
        let u: bigint;
        u = x << 40n;
        x = Source.seedrand(x);
        u = u ^ (x << 20n);
        x = Source.seedrand(x);
        u = u ^ x;
        u = u ^ rngCooked[Number(i)];
        this.vec[Number(i)] = u;
      }
    }
  }

  // Int63 returns a non-negative pseudo-random 63-bit integer as an int64.
  public int63(): bigint {
    return this.uint64() & rngMask;
  }

  // Uint64 returns a non-negative pseudo-random 64-bit integer as an uint64.
  public uint64(): bigint {
    this.tap = this.tap - 1n;
    if (this.tap < 0n) {
      this.tap = this.tap + rngLen;
    }

    this.feed = this.feed - 1n;
    if (this.feed < 0) {
      this.feed = this.feed + rngLen;
    }

    const x = this.vec[Number(this.feed)] + this.vec[Number(this.tap)];
    this.vec[Number(this.feed)] = x;
    return BigInt.asUintN(64, x);
  }
}
